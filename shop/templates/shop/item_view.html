{% extends 'main2.html' %}
{% load static %}

{% block title %}Shop{% endblock title %}

{% block content %}

<section class="py-5">
    <div class="container px-4 px-lg-5 my-5">
        <a href="../"><i class='far fa-arrow-alt-circle-left mb-4' style='color:black; font-size:xx-large;'></i></a>
        <div class="row gx-4 gx-lg-5 align-items-center">
            <div class="col-md-6"><img class="card-img-top mb-5 mb-md-0" src="{{ item.product_image.url }}" alt="..." />
            </div>
            <div class="col-md-6">
                <div class="small mb-1">{{ item.category }}</div>
                <h1 class="display-5 fw-bolder">{{ item.product_name }}</h1>
                <div class="fs-5 mb-5">
                    <span><b>Price: </b></span><span>â‚±{{ item.price }}</span>
                </div>

                <p class="lead">{{ item.description|linebreaksbr}}</p>
                <hr>
                <div class="fs-5 mb-3">
                    <span><b>Remaining Stocks: </b></span> <span id="item_quantity">{{ item.tempo_quantity }} </span>
                    <br>
                    <span><b>Minimum Order: </b></span> <span id ="item_minimum">{{ item.min_orders }}</span>
                </div>

                <form class ="needs-validation" novalidate>
                    <div class="form-inline has-validation">
                        <label><b>Quantity: </b></label>
                        <input min="{{ item.min_orders }}" max="{{ item.tempo_quantity }}" type="number" value="{{ item.min_orders }}" id="inputQuantity" class="form-control text-center me-1 ml-3" required>
                    </div>
                    <p style="color:red;" id="demo"></p>
                    <br>
                    <button class="btn btn-outline-dark flex-shrink-0" id="add-button" value="{{item.id}}" type="button">
                        <i class="bi-cart-fill me-1"></i>
                        Add to cart
                    </button>
                </form>
             

                <div class="form-inline">
                    <label><b>Quantity: </b></label> 
                    <input class="form-control text-center me-1 ml-3"
                        id="inputQuantity" type="num" value="{{ item.min_orders }}" style="max-width: 3rem" />
                </div>
                <button class="btn btn-outline-dark flex-shrink-0 mt-3" id="add-button" value="{{item.id}}" type="button">
                    <i class="bi-cart-fill me-1"></i>
                    Add to cart
                </button>

                <div id="alert-container-1" class="d-none">
                    <div class="alert alert-success alert-dismissible fade show mt-3" id="success" role="alert" style="text-align: center;">
                        Added to cart
                    </div>
                </div>

                <div id="alert-container-2" class="d-none">
                    <div class="alert alert-danger alert-dismissible fade show mt-3" id="error" role="alert" style="text-align: center;">
                        Already exists
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // get the value from the cookie
    var value = getCookie(name);

    // check if the value exists in the cookie
    if (value) {
        document.getElementById("add-button").addEventListener("click", function() {
            document.getElementById("alert-container-2").classList.remove("d-none");
        });
        setTimeout(function () {
        // Closing the alert
        $('#error').alert('close');
        }, 3000);
    } else {
        document.getElementById("add-button").addEventListener("click", function() {
            document.getElementById("alert-container-1").classList.remove("d-none");
        });
        setTimeout(function () {
        // Closing the alert
        $('#success').alert('close');
        }, 3000);
    }

    const addButton = document.querySelector('#add-button');
    const inputQuantity = document.querySelector('#inputQuantity');
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    addButton.addEventListener('click', async function (e) {
        e.preventDefault();
        let x = document.getElementById("inputQuantity").value;
        let text;
        const iStocks = document.getElementById("item_quantity").innerText;
        const iMinimum= document.getElementById("item_minimum").innerText;

        if (isNaN(x) || x < parseInt(iMinimum)) {
            text = "Note: Minimum Quantity is " + iMinimum;
        } 
        else if (x > parseInt(iStocks)) {
            text = "Note: Maximum Quantity is " + iStocks;;
        }
        else {
            text = "";
            const response = await fetch("http://127.0.0.1:8000/cart/add/", {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                productid: addButton.value,
                productqty: inputQuantity.value,
                csrfmiddlewaretoken: "{{csrf_token}}",
                action: 'post'
            })
        })

        const data = await response.json();
        if (data) {
            document.querySelector('#cart-qty').innerHTML = data.qty;
        }


    });
</script>

{% endblock content %}