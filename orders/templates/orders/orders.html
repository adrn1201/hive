{% extends 'main.html' %}
{% block title %}{% endblock title %}

{% block content %}

<style>

p {
    font-size: 14px !important;
}

</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex card mb-4">
                <section class="product_section layout_padding">
                    <div class="mx-4">
                        <div class="heading_container heading_center">
                            <div class="ms-auto" style="margin-top: 4%; margin-right: 3% !important;">
                                <div class="col-lg-5 d-flex mt-4">
                                    &nbsp;
                                    <form action="{% url 'display_orders' %}" method="GET" id="searchForm">
                                        <div class="input-group">
                                            <span class="input-group-text text-body"><i class="fas fa-search" aria-hidden="true"></i></span>
                                            <input type="search" value="{{ search_query }}" class="form-control"
                                                name="q" placeholder="Search Orders">
                                        </div>
                                    </form>
                                    <select class="form-select" id="filter_category" aria-label="Default select example" style="margin-left: 15px; width: 200px; height: 40px;">
                                        <option selected disabled> Filter By: </option>
                                        <option value="pending" {% if request.GET.category and request.GET.category == "pending" %}selected{% endif %}>Pending</option>
                                        <option value="preparing" {% if request.GET.category and request.GET.category == "preparing" %}selected{% endif %}>Preparing</option>
                                        <option value="shipped" {% if request.GET.category and request.GET.category == "shipped" %}selected{% endif %}>Shipping</option>
                                        <option value="completed" {% if request.GET.category and request.GET.category == "completed" %}selected{% endif %}>Completed</option>
                                      </select>
                                </div>
                                <a href="{% url 'sales_report' %}" class="mt-4 btn btn-primary">Generate Sales Report</a>
                                <div id="loading-modal" style="display:none">
                                    <div class="loader"></div>
                                    <p>Please wait, generating PDF...</p>
                                  </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-header pb-0">
                        <div class="d-flex align-items-center">
                            <h6 class="mb-0">Orders</h6>
                        </div>
                    </div>

                    <div class="card-body px-0 pt-2 pb-2">
                        <div class="table-responsive p-0">
                            <table class="table align-items-center mt-2 mb-2">
                                <thead>
                                    <tr>
                                        <th
                                            class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                            Reference Number</th>
                                        <th
                                            class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7 ps-2">
                                            Business Name</th>
                                        <th
                                            class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                            Order Date</th>
                                        <th
                                            class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                            Order Status</th>
                                        <th
                                            class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                            Payment Method</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                    <tr>
                                        <td>
                                            <p class=" font-weight-bold mb-0 text-center">
                                                {{ order.reference_number }}</p>
                                        </td>
                                        <td>
                                            <p class="text-center  font-weight-bold mb-0">
                                                {{ order.business_name }}</p>
                                        </td>
                                        <td class="align-middle text-center">
                                            <p class=" font-weight-bold mb-0">{{ order.created }}</p>
                                        </td>
                
                                        <td class="align-middle text-center text-sm">
                                            {%if order.status == "pending"%}
                                            <span class="badge badge-sm bg-primary">{{order.status}}</span> 
                                            {% endif %}

                                            {%if order.status == "preparing"%}
                                            <span class="badge badge-sm bg-info">{{order.status}}</span> 
                                            {% endif %}

                                            {%if order.status == "shipped"%}
                                            <span class="badge badge-sm bg-warning">{{order.status}}</span> 
                                            {% endif %}

                                            {%if order.status == "completed"%}
                                            <span class="badge badge-sm bg-success">{{order.status}}</span> 
                                            {% endif %}
                                            
                                        </td>
                                        
                                        <td>
                                            <p class="text-center  font-weight-bold mb-0">{{ order.mode_of_payment }}
                                            </p>
                                        </td>
                                        <td>
                                            <a class="btn btn-link text-dark  px-2 mb-0" href="{% url 'order_details' order.id %}"><i class="fas fa-pencil-alt text-dark me-2" aria-hidden="true"></i>View Details</a>
                                        </td>

                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% include 'w-pagination.html' with queryset=orders custom_range=custom_range %}
                    </div>
            </div>
        </div>
    </div>

    {% comment %} <div class="d-flex card mb-4">
        <div class=" d-flex mt-4 mx-4">
            <div id="sales-report-container"></div>
        </div>
    </div> {% endcomment %}

    
      
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('#sales-report-btn').addEventListener('click', function() {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', `sales/`);
          xhr.onload = function() {
            if (xhr.status === 200) {
              var data = JSON.parse(xhr.responseText);
              var totalSales = data.total_sales;
              var averageOrderValue = data.average_order_value;
              var orderThirty = data.orders;

              // Update the HTML with the sales report data
              var salesReportContainer = document.querySelector('#sales-report-container');
              salesReportContainer.innerHTML = `
                <h3> Sales Report for the Last 30 Days</h3>

                <div class="table-responsive p-0">
                    <table class="table align-items-center mt-2 mb-2">
                        <thead>
                            <tr>
                                <th
                                    class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                    Reference Number</th>
                                <th
                                    class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7 ps-2">
                                    Business Name</th>
                                <th
                                    class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                    Order Date</th>
                               
                                <th
                                    class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                    Payment Method</th>
                                <th
                                    class="text-center text-uppercase text-primary th-new font-weight-bolder opacity-7">
                                    Total Amount
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders_thirty %}
                            <tr>
                                <td>
                                    <p class=" font-weight-bold mb-0 text-center">
                                        {{ order.reference_number }}</p>
                                </td>
                                <td>
                                    <p class="text-center  font-weight-bold mb-0">
                                        {{ order.business_name }}</p>
                                </td>
                                <td class="align-middle text-center">
                                    <p class=" font-weight-bold mb-0">{{ order.created }}</p>
                                </td>
                              
                                <td>
                                    <p class="text-center  font-weight-bold mb-0">{{ order.mode_of_payment }}
                                    </p>
                                </td>
                                <td>
                                    <p class="text-center  font-weight-bold mb-0">{{ order.total_paid }}
                                </td>

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <br>
                <p>Total Sales: ${totalSales}</p>
                <p>Average Order Value: ${averageOrderValue}</p>
                
              `;
            
              var opt = {
                margin: [1, 1],
                filename: 'myfile.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                pagebreak: { mode: 'avoid-all' },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'legal', orientation: 'landscape' }
               
              };
              var modal = document.getElementById("loading-modal");
              modal.style.display = "block";

              setTimeout(function() {
              modal.style.display = "none";
              html2pdf().set(opt).from(salesReportContainer).outputPdf("dataurl").then(function(pdf) {
                var popup = window.open();
                popup.document.write("<iframe width='100%' height='100%' src='" + pdf + "'></iframe>");
              });
            }, 1000);


            } else {
              console.error('Error fetching sales report data');
            }
          };
          xhr.send();
        });
      });
      


</script>

{% endblock content %}